//////////////////////////////////////////////////////////////////////////////////////////////////
///   Full area script for Balthazar's throne room
///   (nb. Cutscenes are mostly controlled by the PTBALTH trigger script
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////
///   Reactive stuff
//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
//// Balthazar "flees" (i.e., is removed) if in combat and not an enemy
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	!Allegiance("balth",ENEMY)
	HP("balth",1)
THEN
	RESPONSE #100
		SetInterrupt(FALSE)
		DisplayStringHead("balth",25942) // No such index
		Wait(1)
		ActionOverride("balth",ChangeAIScript("",DEFAULT)
		ActionOverride("balth",ReallyForceSpell(Myself,DRYAD_TELEPORT))
		SetGlobal("DMWWbalthfled","GLOBAL",1)
		SetInterrupt(TRUE)
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//// Death conversation with a hostile Balthazar
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Allegiance("balth",ENEMY)
	HP("balth",1)
	HasItem("minhp1","balth")
THEN
	RESPONSE #100
		ActionOverride("balth",StartDialogueNoSet(Player1))
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//// Death conversation with a hostile Melissan
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	HP("dw#melis",1)
	Global("DMWWmeldeathdialog","GLOBAL",0)
THEN
	RESPONSE #100
		SetGlobal("DMWWmeldeathdialog","GLOBAL",1)
		ActionOverride("dw#melis",StartDialogNoSet(Player1))
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//// Autosave after Mel's death
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("DMWWmeldeathdialog","GLOBAL",1)
THEN
	RESPONSE #100
		SaveGame(0)
		StartMusic(0,1)
		SetGlobal("DMWWmeldeathdialog","GLOBAL",2)
END

//////////////////////////////////////////////////////////////////////////////////////////////////
////   Restore Balth if he was reduced to 1 hp in the fight with Melissan
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("DMWWmeldeathdialog","GLOBAL",2)
	Global("DMWWbalthfled","GLOBAL",1)
THEN
	RESPONSE #100
		SetGlobal("DMWWbalthfled","GLOBAL",2)
		ClearAllActions()
		StartCutSceneMode()
		CreateCreatureObjectDoor("balth",Player1,0,0,0)
		Wait(1)
		EndCutSceneMode()
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////
////    Phase 1
//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
////    Cutscene: initial monk debrief
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("BalthazarEncounter","AR5505",0)
	Global("HadBhaal25Dream2","GLOBAL",0)
	Global("DMWWBalthFirst","GLOBAL",0)
THEN
	RESPONSE #100
		ClearAllActions()
		SetGlobal("BalthazarEncounter","AR5505",1)
		StartCutSceneMode()
		StartCutScene("dw#balc1")
END


//////////////////////////////////////////////////////////////////////////////////////////////////
////    Dream scene if Balth is killed
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Dead("balth")
	Global("HadBhaal25Dream2","GLOBAL",0)
THEN
	RESPONSE #100
		ClearAllActions()
		SetGlobal("HadBhaal25Dream2","GLOBAL",1)
		SetGlobal("DMWWBalthDeadPhase1","GLOBAL",1)
		StartCutSceneMode()
		StartCutScene("cut234a")
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////
////    Phase 2
//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
////    Cutscene: mel/Bal faceoff
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("BalthazarEncounter","AR5505",0)
	Global("HadBhaal25Dream2","GLOBAL",1)
	Global("HadBhaal25Dream3","GLOBAL",0)
THEN
	RESPONSE #100
		ClearAllActions()
		SetGlobal("BalthazarEncounter","AR5505",1)
		StartCutSceneMode()
		StartCutScene("dw#balc2")
END


//////////////////////////////////////////////////////////////////////////////////////////////////
////    Dream scene if Balth is killed (dream if you parley with him is handled by his dialog script)
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Dead("balth")
	OR(2)
		Dead("sendai")
		Dead("abazigal")
	Global("HadBhaal25Dream2","GLOBAL",1)
	Global("HadBhaal25Dream3","GLOBAL",0)
THEN
	RESPONSE #100
		ClearAllActions()
		SetGlobal("HadBhaal25Dream3","GLOBAL",1)
		StartCutSceneMode()
		StartCutScene("cut235a")
END

//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////
////    If the enclave is about to be attacked by Sendai, ensure it's dark
//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
        Global("HadBhaal25Dream3","GLOBAL",1)
        !Dead("sendai")
	TimeGT(DAWN_START)
	TimeLT(DUSK_START)
	!Global("DMWWVillageAttacked","GLOBAL",2)
THEN
     RESPONSE #100
              DayNight(MIDNIGHT)
END


//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////
////    Phase 3
//////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
////    If Balth is killed, spawn Melissan
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("DMWWNoteMelFled","GLOBAL",0)
	Dead("balth")
	Dead("abazigal")
	Dead("sendai")
	!Dead("dw#melis")
THEN
	RESPONSE #100
		SetGlobal("DMWWNoteMelFled","GLOBAL",1)
		StartCutSceneMode()
		StartCutScene("dw#balc7")
END

//////////////////////////////////////////////////////////////////////////////////////////////////
////    Call Melissan if player parleys in phase 3
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("DMWWBvMEnd","GLOBAL",1)
	!GlobalTimerNotExpired("DMWWBalCallsMel","GLOBAL")
THEN
	RESPONSE #100
		SetGlobal("DMWWBvMEnd","GLOBAL",2)
		StartCutSceneMode()
		StartCutScene("dw#balc5")
END

//////////////////////////////////////////////////////////////////////////////////////////////////
////    Spawn Balthazar if party parleyed in phase 2
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Dead("sendai")
	Dead("abazigal")
	Global("BalthazarFights","GLOBAL",1)
	Global("DMWWBalthMidAlliance","GLOBAL",1)
	!Global("DMWWSpawnBalthPostAS","GLOBAL",1)
THEN
	RESPONSE #100
		SetGlobal("DMWWSpawnBalthPostAS","GLOBAL",1)
		CreateCreature("balth",[760.515],14)
END

//////////////////////////////////////////////////////////////////////////////////////////////////
////    Reveal the grove if party picked up the book
//////////////////////////////////////////////////////////////////////////////////////////////////

IF
	Global("DMWWGroveRevealed","GLOBAL",0)
	PartyHasItem("dw#balbo")
THEN	
	RESPONSE #100
		SetGlobal("DMWWGroveRevealed","GLOBAL",1)
		AddJournalEntry(@1016,QUEST_DONE)
END









